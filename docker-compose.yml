# =============================================================================
# Autonomous Research Agent - Docker Compose Configuration
# =============================================================================
#
# Profiles:
#   default:    Production mode (optimized, secure)
#   dev:        Development mode (hot reload, debug)
#
# Usage:
#   Production:  docker-compose up -d
#   Development: docker-compose --profile dev up
#   Logs:        docker-compose logs -f
#   Rebuild:     docker-compose up -d --build
#   Stop:        docker-compose down
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Production Service
  # ---------------------------------------------------------------------------
  research-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: research-agent
    restart: unless-stopped

    ports:
      - "${STREAMLIT_PORT:-8501}:8501"

    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - APP_ENV=production
      - DEBUG=false
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

    volumes:
      - research_sessions:/app/research_sessions
      - papers_data:/app/papers

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - research-network

  # ---------------------------------------------------------------------------
  # Development Service
  # ---------------------------------------------------------------------------
  research-agent-dev:
    profiles:
      - dev
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: research-agent-dev
    restart: "no"

    ports:
      - "${STREAMLIT_PORT:-8501}:8501"

    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - APP_ENV=development
      - DEBUG=true
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_RUN_ON_SAVE=true

    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:ro
      - ./streamlit_app.py:/app/streamlit_app.py:ro
      - ./research_sessions:/app/research_sessions
      - ./papers:/app/papers
      - ./.env:/app/.env:ro

    networks:
      - research-network

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  research-network:
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  research_sessions:
    driver: local
  papers_data:
    driver: local
